{{#section 'css'}}
<style>
    .restricted-view-container {
        max-width: 800px;
        margin: 3rem auto;
        padding: 0 1rem;
    }
    
    .restricted-card {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        border: 2px solid var(--border-light);
    }
    
    .restricted-icon {
        font-size: 4rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
    }
    
    .restricted-title {
        color: var(--text-color);
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .restricted-message {
        color: var(--text-muted);
        font-size: 1.1rem;
        margin-bottom: 2rem;
    }
    
    .product-preview-card {
        background: var(--bg-gray);
        border-radius: var(--radius-md);
        padding: 2rem;
        margin: 2rem 0;
    }
    
    .preview-image {
        max-height: 300px;
        object-fit: cover;
        border-radius: var(--radius-sm);
        margin-bottom: 1.5rem;
    }
    
    .product-detail-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }
    
    .product-gallery {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-light);
        height: fit-content;
    }
    
    .main-image-container {
        position: relative;
        background: linear-gradient(135deg, var(--bg-gray), var(--bg-white));
        border-radius: var(--radius-md);
        padding: 1rem;
        border: 2px solid var(--border-light);
        overflow: hidden;
        cursor: zoom-in;
    }
    
    .main-image {
        width: 100%;
        height: 400px;
        object-fit: contain;
        border-radius: var(--radius-sm);
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        will-change: transform;
    }
    
    .main-image-container:hover .main-image {
        transform: scale(1.05);
    }
    
    .main-image.loading {
        opacity: 0.5;
    }
    
    .main-image.fade-in {
        animation: fadeInImage 0.4s ease-in;
    }
    
    @keyframes fadeInImage {
        from {
            opacity: 0;
            transform: scale(0.98);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    .image-loading-skeleton {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            90deg,
            var(--bg-gray) 0%,
            #e9ecef 50%,
            var(--bg-gray) 100%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: var(--radius-sm);
        display: none;
    }
    
    .main-image.loading + .image-loading-skeleton {
        display: block;
    }
    
    @keyframes shimmer {
        0% {
            background-position: -200% 0;
        }
        100% {
            background-position: 200% 0;
        }
    }
    
    .zoom-icon {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.3s ease;
        pointer-events: none;
        backdrop-filter: blur(5px);
    }
    
    .main-image-container:hover .zoom-icon {
        opacity: 1;
        transform: scale(1.1);
    }
    
    .gallery-thumbs {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        margin-top: 1rem;
        flex-wrap: wrap;
        padding: 0.5rem;
    }
    
    .thumb-wrapper {
        position: relative;
        border-radius: var(--radius-sm);
        overflow: hidden;
    }
    
    .gallery-thumb {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: var(--radius-sm);
        border: 3px solid var(--border-light);
        cursor: pointer;
        opacity: 0.6;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: block;
        filter: grayscale(30%);
    }
    
    .gallery-thumb:hover {
        opacity: 0.9;
        border-color: var(--accent-secondary);
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        filter: grayscale(0%);
    }
    
    .gallery-thumb.active {
        opacity: 1;
        border-color: var(--accent-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 140, 140, 0.4);
        filter: grayscale(0%);
    }
    
    .thumb-number {
        position: absolute;
        top: 4px;
        left: 4px;
        background: rgba(74, 140, 140, 0.9);
        color: white;
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 3px;
        backdrop-filter: blur(5px);
        z-index: 1;
        pointer-events: none;
    }
    
    .thumb-wrapper.active .thumb-number {
        background: rgba(74, 140, 140, 1);
    }
    
    .product-info {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-light);
    }
    
    /* Lightbox Modal */
    .lightbox-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
        backdrop-filter: blur(10px);
    }
    
    .lightbox-modal.active {
        display: flex;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    .lightbox-content {
        position: relative;
        max-width: 90%;
        max-height: 90vh;
        animation: zoomIn 0.3s ease;
    }
    
    @keyframes zoomIn {
        from {
            transform: scale(0.8);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .lightbox-image {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: var(--radius-md);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .lightbox-close {
        position: absolute;
        top: -50px;
        right: 0;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    
    .lightbox-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg) scale(1.1);
    }
    
    .lightbox-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    
    .lightbox-nav:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-50%) scale(1.1);
    }
    
    .lightbox-prev {
        left: 20px;
    }
    
    .lightbox-next {
        right: 20px;
    }
    
    .lightbox-counter {
        position: absolute;
        bottom: -50px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 14px;
        backdrop-filter: blur(10px);
    }
    
    .product-title {
        color: var(--text-color);
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
        line-height: 1.2;
    }
    
    .product-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-light);
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-muted);
        font-size: 0.9rem;
    }
    
    .pricing-section {
        background: linear-gradient(135deg, #fef7f0, #fff);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        position: relative;
    }
    
    .current-price {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--danger-color);
        margin: 0;
        text-shadow: 0 1px 2px rgba(220, 38, 38, 0.1);
    }
    
    .price-details {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
        align-items: center;
    }
    
    .price-item {
        background: var(--bg-white);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-full);
        border: 1px solid var(--border-light);
        font-size: 0.85rem;
        color: var(--text-muted);
    }
    
    .buy-now-badge {
        background: linear-gradient(135deg, var(--success-color), #059669);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-full);
        font-weight: 600;
        font-size: 0.9rem;
        border: none;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-watchlist {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--bg-white);
        border: 2px solid var(--border-color);
        color: var(--text-muted);
        border-radius: var(--radius-full);
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        transition: var(--transition);
        cursor: pointer;
        z-index: 10;
    }
    
    .btn-watchlist:hover {
        background: var(--danger-color);
        border-color: var(--danger-color);
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-watchlist:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* User Info Cards */
    .user-info-card {
        background: var(--bg-gray);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: 1rem;
        height: 100%;
    }
    
    .user-info-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-muted);
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .user-info-content h6 {
        color: var(--text-color);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .rating-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .rating-score {
        background: var(--primary-color);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .rating-stars {
        color: #fbbf24;
        font-size: 0.8rem;
    }
    
    /* Countdown Timer */
    .countdown-section {
        background: linear-gradient(135deg, #fef3c7, #fef7cd);
        border: 2px solid #f59e0b;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .countdown-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        color: #92400e;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .countdown-timer {
        font-size: 1.5rem;
        font-weight: 800;
        color: #92400e;
        margin-bottom: 0.5rem;
    }
    
    .countdown-end-time {
        color: #92400e;
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    /* Custom Alerts */
    .custom-alert {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        position: relative;
    }
    
    .alert-error {
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
        border: 1px solid #fca5a5;
    }
    
    .alert-error i {
        color: var(--danger-color);
        font-size: 1.2rem;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        border: 1px solid #86efac;
    }
    
    .alert-success i {
        color: var(--success-color);
        font-size: 1.2rem;
    }
    
    .alert-close {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: var(--radius-sm);
    }
    
    .alert-close:hover {
        background: rgba(0,0,0,0.1);
    }
    
    /* Bidding Section */
    .bidding-section {
        background: linear-gradient(135deg, #eff6ff, #dbeafe);
        border: 2px solid var(--primary-color);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .bidding-input-group {
        text-align: center;
    }
    
    .bid-label {
        display: block;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }
    
    .bid-input-container {
        display: flex;
        align-items: center;
        background: var(--bg-white);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
        margin-bottom: 0.75rem;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .currency-symbol {
        padding: 0.75rem 1rem;
        background: var(--bg-gray);
        border-right: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--text-color);
    }
    
    .bid-input {
        flex: 1;
        border: none;
        padding: 0.75rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--danger-color);
        text-align: center;
    }
    
    .bid-input:focus {
        outline: none;
    }

    .bid-controls {
        display: flex;
        flex-direction: column;
        border-left: 1px solid var(--border-color);
        border-right: 1px solid var(--border-color);
    }

    .btn-increment, .btn-decrement {
        background: var(--bg-gray);
        border: none;
        padding: 0.25rem 0.75rem;
        cursor: pointer;
        transition: var(--transition);
        color: var(--text-color);
        font-size: 0.9rem;
    }

    .btn-increment {
        border-bottom: 1px solid var(--border-color);
    }

    .btn-increment:hover {
        background: var(--primary-color);
        color: white;
    }

    .btn-decrement:hover {
        background: var(--danger-color);
        color: white;
    }
    
    .bid-btn {
        background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .bid-btn:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        transform: translateX(2px);
    }
    
    .bid-hint {
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    /* Auction Ended Alert */
    .auction-ended-alert {
        background: linear-gradient(135deg, #fee2e2, #fef3c7);
        border: 2px solid #fbbf24;
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1.5rem;
        align-items: flex-start;
        box-shadow: var(--shadow-md);
    }

    .auction-ended-alert .alert-icon {
        font-size: 3rem;
        color: #f59e0b;
        flex-shrink: 0;
    }

    .auction-ended-alert .alert-content {
        flex: 1;
    }

    .auction-ended-alert h5 {
        color: #92400e;
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-size: 1.25rem;
    }

    .auction-ended-alert p {
        color: #78350f;
        margin-bottom: 0.5rem;
    }

    .auction-ended-alert .winner-info {
        background: rgba(255, 255, 255, 0.7);
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    /* Seller Info Alert */
    .seller-info-alert {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        border: 2px solid #3b82f6;
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1.5rem;
        align-items: flex-start;
        box-shadow: var(--shadow-md);
    }

    .seller-info-alert .alert-icon {
        font-size: 3rem;
        color: #2563eb;
        flex-shrink: 0;
    }

    .seller-info-alert .alert-content {
        flex: 1;
    }

    .seller-info-alert h5 {
        color: #1e3a8a;
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-size: 1.25rem;
    }

    .seller-info-alert p {
        color: #1e40af;
        margin-bottom: 0.5rem;
    }

    .seller-info-alert .current-status {
        background: rgba(255, 255, 255, 0.7);
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        margin-top: 1rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    /* Login Prompt */
    .login-prompt {
        background: linear-gradient(135deg, var(--bg-gray), var(--bg-white));
        border: 2px dashed var(--border-color);
        border-radius: var(--radius-lg);
        padding: 3rem 2rem;
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .login-prompt-content i {
        font-size: 3rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
    }
    
    .login-prompt-content h5 {
        color: var(--text-color);
        margin-bottom: 0.75rem;
    }
    
    .login-prompt-content p {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }
    
    .login-btn {
        background: linear-gradient(135deg, var(--primary-color), #1d4ed8);
        color: white;
        text-decoration: none;
        padding: 0.75rem 2rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        transition: var(--transition);
        display: inline-block;
    }
    
    .login-btn:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    /* Product Sections */
    .product-section {
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-lg);
        margin-bottom: 2rem;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }
    
    .section-header {
        background: linear-gradient(135deg, var(--bg-gray), #f8fafc);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .section-header h4 {
        margin: 0;
        color: var(--text-color);
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .bid-count {
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-full);
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .section-content {
        padding: 2rem;
    }
    
    .product-description {
        line-height: 1.7;
        color: var(--text-color);
        position: relative;
    }

    .product-description.collapsed {
        max-height: 200px;
        overflow: hidden;
        position: relative;
    }

    .product-description.collapsed::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: linear-gradient(to bottom, transparent, white);
        pointer-events: none;
    }

    .show-more-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding: 0.5rem 1.25rem;
        background: var(--accent-primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }

    .show-more-btn:hover {
        background: #3a7070;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(74, 140, 140, 0.2);
    }

    .show-more-btn i {
        transition: transform 0.3s;
    }

    .show-more-btn.expanded i {
        transform: rotate(180deg);
    }
    
    .product-description h1,
    .product-description h2,
    .product-description h3,
    .product-description h4,
    .product-description h5,
    .product-description h6 {
        color: var(--text-color);
        margin: 1.5rem 0 1rem;
    }
    
    .product-description p {
        margin-bottom: 1rem;
    }
    
    .product-description img {
        max-width: 100%;
        height: auto;
        border-radius: var(--radius-md);
        margin: 1rem 0;
    }
    
    /* Bid History Table */
    .bid-history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .bid-history-table.collapsed tbody tr:nth-child(n+6) {
        display: none;
    }

    .bid-history-collapsed-indicator {
        text-align: center;
        padding: 1rem;
        color: #6c757d;
        font-style: italic;
        background: #f8f9fa;
        border-radius: var(--radius-md);
        margin-top: 0.5rem;
    }
    
    .bid-history-table th,
    .bid-history-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-light);
    }
    
    .bid-history-table th {
        background: var(--bg-gray);
        font-weight: 600;
        color: var(--text-color);
        font-size: 0.9rem;
    }
    
    .bid-history-table tr:hover {
        background: var(--bg-gray);
    }
    
    .bid-user {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-color);
    }
    
    .bid-price {
        font-weight: 600;
        color: var(--success-color);
        font-size: 1.1rem;
    }
    
    .bid-time {
        color: var(--text-muted);
        font-size: 0.9rem;
    }
    
    .kick-btn {
        background: linear-gradient(135deg, var(--danger-color), #dc2626);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        font-size: 0.8rem;
        font-weight: 500;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .kick-btn:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .kick-btn.disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .kick-btn.disabled:hover {
        transform: none;
    }

    .banned-bid {
        background-color: #fff3cd !important;
        opacity: 0.7;
    }

    .winning-bid {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
        border: 4px solid #28a745 !important;
        box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.2), 0 4px 12px rgba(40, 167, 69, 0.3) !important;
        position: relative;
        animation: winnerGlow 2s ease-in-out infinite;
    }

    @keyframes winnerGlow {
        0%, 100% { 
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.2), 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        50% { 
            box-shadow: 0 0 0 6px rgba(40, 167, 69, 0.3), 0 4px 20px rgba(40, 167, 69, 0.5);
        }
    }

    .winning-bid .bid-time {
        font-weight: 700;
        color: #155724;
        font-size: 1.05rem;
        position: relative;
        padding-left: 2.5rem;
    }

    .winning-bid .bid-time::before {
        content: 'üèÜ';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.8rem;
        animation: pulse 2s ease-in-out infinite;
        display: inline-block;
        filter: drop-shadow(0 2px 4px rgba(40, 167, 69, 0.4));
    }

    .winning-bid .bid-time::after {
        content: 'WINNER';
        position: absolute;
        left: 0;
        bottom: -18px;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 3px;
        font-weight: 700;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }

    @keyframes pulse {
        0%, 100% { 
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }
        50% { 
            transform: translateY(-50%) scale(1.15);
            opacity: 0.85;
        }
    }

    .winning-bid .bid-price {
        color: #28a745 !important;
        font-weight: 800 !important;
        font-size: 1.35rem !important;
        text-shadow: 0 1px 3px rgba(40, 167, 69, 0.3);
        letter-spacing: 0.5px;
    }

    .winning-bid .bid-user {
        font-weight: 700;
        color: #155724;
    }

    .winning-bid:hover {
        background: linear-gradient(135deg, #c3e6cb 0%, #b1dfbb 100%) !important;
        border-color: #20c997 !important;
    }

    .rating-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.9rem;
        color: #495057;
    }
    
    .no-bids {
        text-align: center;
        color: var(--text-muted);
        padding: 3rem;
        font-style: italic;
    }
    
    .no-bids i {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
        opacity: 0.5;
    }
    
    /* Related Products */
    .related-product-card {
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        overflow: hidden;
        transition: var(--transition);
        height: 100%;
    }
    
    .related-product-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary-color);
    }
    
    .product-link {
        text-decoration: none;
        color: inherit;
        display: block;
        height: 100%;
    }
    
    .product-link:hover {
        color: inherit;
        text-decoration: none;
    }
    
    .related-image {
        height: 140px;
        overflow: hidden;
        background: var(--bg-gray);
    }
    
    .related-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: var(--transition);
    }
    
    .related-product-card:hover .related-image img {
        transform: scale(1.05);
    }
    
    .related-info {
        padding: 1rem;
    }
    
    .related-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.3;
    }
    
    .related-price {
        color: var(--danger-color);
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .related-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    
    .time-left {
        background: var(--bg-gray);
        padding: 0.2rem 0.5rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
    }
    
    /* Comments Section */
    .comments-list {
        space-y: 1.5rem;
    }
    
    .comment-item {
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-light);
        margin-bottom: 1.5rem;
    }
    
    .comment-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .comment-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }
    
    .comment-author {
        color: var(--text-color);
        font-weight: 600;
        margin: 0;
    }
    
    .comment-date {
        color: var(--text-muted);
        font-size: 0.85rem;
    }
    
    .comment-content {
        color: var(--text-color);
        line-height: 1.6;
        margin: 0;
    }
    
    /* Responsive Image Gallery */
    @media (max-width: 768px) {
        .main-image {
            height: 300px;
        }
        
        .gallery-thumb {
            width: 60px;
            height: 60px;
        }
        
        .thumb-number {
            font-size: 9px;
            padding: 2px 5px;
        }
        
        .zoom-icon {
            width: 35px;
            height: 35px;
            font-size: 14px;
        }
        
        .lightbox-content {
            max-width: 95%;
        }
        
        .lightbox-close {
            top: -45px;
            width: 40px;
            height: 40px;
            font-size: 20px;
        }
        
        .lightbox-nav {
            width: 40px;
            height: 40px;
            font-size: 20px;
        }
        
        .lightbox-prev {
            left: 10px;
        }
        
        .lightbox-next {
            right: 10px;
        }
        
        .lightbox-counter {
            bottom: -45px;
            font-size: 12px;
            padding: 6px 16px;
        }
    }
    
    @media (max-width: 480px) {
        .main-image {
            height: 250px;
        }
        
        .gallery-thumbs {
            gap: 0.5rem;
        }
        
        .gallery-thumb {
            width: 50px;
            height: 50px;
        }
        
        .product-gallery {
            padding: 1rem;
        }
    }
</style>
{{/section}}

{{!-- Check if product has ended (status = 2) and user is not buyer/seller --}}
{{#if (isEqual product.status 2)}}
    {{#if (or (isEqual product.winner_id authUser.id) (isEqual product.seller_id authUser.id))}}
        {{!-- Buyer or Seller ‚Üí Redirect to transaction view --}}
        <script>
            window.location.href = '/transaction/{{product.id}}';
        </script>
    {{else}}
        {{!-- Other users ‚Üí Show restricted info --}}
        <div class="restricted-view-container">
            <div class="restricted-card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-lock restricted-icon"></i>
                    <h1 class="restricted-title">S·∫£n ph·∫©m ƒë√£ k·∫øt th√∫c</h1>
                    <p class="restricted-message">Phi√™n ƒë·∫•u gi√° cho s·∫£n ph·∫©m n√†y ƒë√£ k·∫øt th√∫c.</p>
                    
                    {{!-- Basic product info --}}
                    <div class="product-preview-card">
                        <picture>
                            <source srcset="{{images.[0].src}}" type="image/webp">
                            <img src="{{images.[0].src}}" class="img-fluid preview-image" alt="{{product.name}}" width="600" height="400">
                        </picture>
                        <h3 class="mb-3">{{product.name}}</h3>
                        <p class="text-success fs-4 mb-2">
                            <i class="bi bi-trophy-fill"></i>
                            Gi√° cu·ªëi: {{format_currency product.current_price}}
                        </p>
                        <p class="text-muted mb-2">
                            <i class="bi bi-calendar-check"></i>
                            K·∫øt th√∫c: {{format_date product.end_time}}
                        </p>
                        <p class="text-muted mb-0">
                            <i class="bi bi-tag"></i>
                            Danh m·ª•c: {{product.category_name}}
                        </p>
                    </div>
                    
                    <a href="/" class="btn btn-primary btn-lg">
                        <i class="bi bi-house"></i> V·ªÅ trang ch·ªß
                    </a>
                    <a href="/products?cat={{product.category_id}}" class="btn btn-outline-secondary btn-lg ms-2">
                        <i class="bi bi-search"></i> Xem s·∫£n ph·∫©m t∆∞∆°ng t·ª±
                    </a>
                </div>
            </div>
        </div>
        
        {{!-- Stop rendering rest of page --}}
        <script>
            // Prevent any further content from loading
            document.addEventListener('DOMContentLoaded', function() {
                const mainContent = document.querySelector('.product-detail-container');
                if (mainContent) mainContent.remove();
            });
        </script>
    {{/if}}
{{/if}}

{{!-- Normal product detail page (only show if not ended or user is participant) --}}
{{#unless (and (isEqual product.status 2) (not (or (isEqual product.winner_id authUser.id) (isEqual product.seller_id authUser.id))))}}
<div class="product-detail-container">
    <div class="row g-4">
        <div class="col-lg-5">
            <div class="product-gallery">
                <div class="main-image-container" onclick="openLightbox(0)">
                    <picture>
                        <source srcset="{{images.[0].src}}" type="image/webp">
                        <img src="{{images.[0].src}}" id="mainImage" class="main-image" alt="{{product.name}}" width="800" height="600">
                    </picture>
                    <div class="image-loading-skeleton"></div>
                    <div class="zoom-icon">
                        <i class="bi bi-zoom-in"></i>
                    </div>
                </div>
                <div class="gallery-thumbs">
                    {{#each images}}
                    <div class="thumb-wrapper {{#if active}}active{{/if}}" data-index="{{@index}}">
                        <span class="thumb-number">{{addOne @index}}</span>
                        <picture>
                            <source srcset="{{src}}" type="image/webp">
                            <img src="{{src}}" loading="lazy" 
                                 class="gallery-thumb {{#if active}}active{{/if}}" 
                                 onclick="changeImage(this, '{{src}}', {{@index}})"
                                 alt="Product image {{addOne @index}}">
                        </picture>
                    </div>
                    {{/each}}
                </div>
            </div>
            
            <!-- Lightbox Modal -->
            <div class="lightbox-modal" id="lightboxModal" onclick="closeLightbox(event)">
                <div class="lightbox-content">
                    <button class="lightbox-close" onclick="closeLightbox(event)">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button class="lightbox-nav lightbox-prev" onclick="navigateLightbox(-1, event)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <img src="" id="lightboxImage" class="lightbox-image" alt="Product image">
                    <button class="lightbox-nav lightbox-next" onclick="navigateLightbox(1, event)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <div class="lightbox-counter" id="lightboxCounter"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="product-info">
                <h1 class="product-title">{{product.name}}</h1>
                
                <div class="product-meta">
                    <div class="meta-item">
                        <i class="bi bi-calendar"></i>
                        <span>Listed: {{product.created_at}}</span>
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-eye"></i>
                        <span>{{product.views}} views</span>
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-tag"></i>
                        <span>{{product.category_name}}</span>
                    </div>
                </div>

                <div class="pricing-section">
                    <button class="btn btn-watchlist" data-id="{{product.id}}">
                        <i class="bi bi-heart"></i> Watch
                    </button>
                    
                    <div>
                        <h2 class="current-price">{{format_currency product.current_price}}</h2>
                        <div class="price-details">
                            <span class="price-item">Starting: {{format_currency product.start_price}}</span>
                            <span class="price-item">Increment: {{format_currency product.step_price}}</span>
                            {{#if product.buy_now_price}}
                            <span class="buy-now-badge">Buy Now: {{format_currency product.buy_now_price}}</span>
                            {{/if}}
                        </div>
                    </div>

                    </div>
                </div>

                <!-- User Info Section -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="user-info-card">
                            <div class="user-info-header">
                                <i class="bi bi-shop"></i>
                                <span>Seller</span>
                            </div>
                            <div class="user-info-content">
                                <h6>{{product.seller_masked}}</h6>
                                <div class="rating-display">
                                    {{#if product.seller_point}}
                                        <span class="rating-score">{{product.seller_point}}%</span>
                                        <small class="text-muted">positive</small>
                                    {{else}}
                                        <span class="text-muted">No rating</span>
                                    {{/if}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="user-info-card">
                            <div class="user-info-header">
                                <i class="bi bi-trophy"></i>
                                <span>Leading Bidder</span>
                            </div>
                            <div class="user-info-content">
                                <h6>{{product.winner_masked}}</h6>
                                <div class="rating-display">
                                    {{#if product.winner_point}}
                                        <span class="rating-score">{{product.winner_point}}%</span>
                                        <small class="text-muted">positive</small>
                                    {{else}}
                                        <span class="text-muted">No rating</span>
                                    {{/if}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Countdown Timer -->
                <div class="countdown-section">
                    <div class="countdown-header">
                        <i class="bi bi-clock"></i>
                        <span>Time Remaining</span>
                    </div>
                    <div class="countdown-timer">
                        {{format_remainingTime product.end_time}}
                    </div>
                    <div class="countdown-end-time">
                        Ends: {{product.end_time}}
                    </div>
                </div>

                <!-- Bidding Form -->
                {{#if isAuthenticated}}
                {{#if (isEqual product.seller_id authUser.id)}}
                <!-- Seller viewing own product -->
                {{#if isExpired}}
                <div class="auction-ended-alert">
                    <div class="alert-icon">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <div class="alert-content">
                        <h5>ƒê·∫•u gi√° ƒë√£ k·∫øt th√∫c</h5>
                        <p>Phi√™n ƒë·∫•u gi√° cho s·∫£n ph·∫©m c·ªßa b·∫°n ƒë√£ h·∫øt h·∫°n.</p>
                        {{#if product.winner_id}}
                        <p class="winner-info">
                            <i class="bi bi-trophy-fill text-warning"></i>
                            Ng∆∞·ªùi th·∫Øng: <strong>{{product.winner_masked}}</strong> 
                            v·ªõi gi√° <strong>{{format_currency product.current_price}}</strong>
                        </p>
                        <p class="text-muted mt-2">Vui l√≤ng li√™n h·ªá v·ªõi ng∆∞·ªùi th·∫Øng ƒë·ªÉ ho√†n t·∫•t giao d·ªãch.</p>
                        {{else}}
                        <p class="text-muted">Kh√¥ng c√≥ ng∆∞·ªùi ƒë·∫∑t gi√° cho s·∫£n ph·∫©m n√†y.</p>
                        {{/if}}
                    </div>
                </div>
                {{else}}
                <div class="seller-info-alert">
                    <div class="alert-icon">
                        <i class="bi bi-shop"></i>
                    </div>
                    <div class="alert-content">
                        <h5>ƒê√¢y l√† s·∫£n ph·∫©m c·ªßa b·∫°n</h5>
                        <p>B·∫°n kh√¥ng th·ªÉ ƒë·∫•u gi√° s·∫£n ph·∫©m c·ªßa ch√≠nh m√¨nh.</p>
                        <p class="current-status">
                            <strong>Gi√° hi·ªán t·∫°i:</strong> {{format_currency product.current_price}}
                            {{#if product.winner_id}}
                            <br><strong>Ng∆∞·ªùi ƒëang d·∫´n ƒë·∫ßu:</strong> {{product.winner_masked}}
                            {{/if}}
                        </p>
                        <p class="text-muted">
                            <i class="bi bi-clock"></i> Th·ªùi gian c√≤n l·∫°i: {{format_remainingTime product.end_time}}
                        </p>
                    </div>
                </div>
                {{/if}}
                {{else}}
                <!-- Regular bidder or guest -->
                {{#if isExpired}}
                <!-- Auction Ended Alert -->
                <div class="auction-ended-alert">
                    <div class="alert-icon">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <div class="alert-content">
                        <h5>ƒê·∫•u gi√° ƒë√£ k·∫øt th√∫c</h5>
                        <p>Phi√™n ƒë·∫•u gi√° n√†y ƒë√£ h·∫øt h·∫°n. B·∫°n kh√¥ng th·ªÉ ra gi√° th√™m.</p>
                        {{#if product.winner_id}}
                        <p class="winner-info">
                            <i class="bi bi-trophy-fill text-warning"></i>
                            Ng∆∞·ªùi th·∫Øng: <strong>{{product.winner_masked}}</strong> 
                            v·ªõi gi√° <strong>{{format_currency product.current_price}}</strong>
                        </p>
                        {{else}}
                        <p class="text-muted">Kh√¥ng c√≥ ng∆∞·ªùi ƒë·∫∑t gi√° cho s·∫£n ph·∫©m n√†y.</p>
                        {{/if}}
                    </div>
                </div>
                {{else}}
                <div class="bidding-section">
                    <form method="post" action="/products/bid" id="frmBid">
                        <input type="hidden" name="id" value="{{product.id}}">
                        
                        <div class="bidding-input-group">
                            <label class="bid-label">Your Bid</label>
                            <div class="bid-input-container">
                                <span class="currency-symbol">$</span>
                                <input type="text" class="bid-input" name="price" 
                                    value="{{nextBidPrice}}" 
                                    data-min="{{nextBidPrice}}"
                                    data-step="{{product.step_price}}"
                                    id="bidPriceInput"
                                    required>
                                <div class="bid-controls">
                                    <button type="button" class="btn-increment" onclick="incrementBid()" title="TƒÉng gi√°">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    <button type="button" class="btn-decrement" onclick="decrementBid()" title="Gi·∫£m gi√°">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                </div>
                                <button type="button" class="bid-btn" onclick="confirmBid()">
                                    <i class="bi bi-hammer me-2"></i>Place Bid
                                </button>
                            </div>
                            <div class="bid-hint">
                                Minimum bid: {{format_currency nextBidPrice}}
                            </div>
                        </div>
                    </form>
                </div>
                {{/if}}
                {{/if}}
            {{else}}
                <div class="login-prompt">
                    <div class="login-prompt-content">
                        <i class="bi bi-person-plus"></i>
                        <h5>Join to Start Bidding</h5>
                        <p>Sign in to place bids and participate in auctions</p>
                        <a href="/account/signin?retUrl=/products/detail/{{product.id}}" class="login-btn">
                            Sign In to Bid
                        </a>
                    </div>
                </div>
                </div>
            {{/if}}
            </div>
        </div>
    </div>
</div>

<!-- Product Description -->
<div class="product-section">
    <div class="section-header">
        <h4><i class="bi bi-file-earmark-text me-2"></i>Product Description</h4>
        {{#if (and isAuthenticated (isEqual product.seller_id authUser.id))}}
            {{#if (isEqual product.status 1)}}
            <a href="/products/edit/{{product.id}}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-pencil-square"></i> B·ªï sung m√¥ t·∫£
            </a>
            {{else}}
            <button class="btn btn-sm btn-secondary" disabled title="ƒê·∫•u gi√° ƒë√£ k·∫øt th√∫c">
                <i class="bi bi-pencil-square"></i> B·ªï sung m√¥ t·∫£
            </button>
            {{/if}}
        {{/if}}
    </div>
    <div class="section-content">
        <div class="product-description collapsed" id="productDescription">
            {{{product.description}}}
        </div>
        <button class="show-more-btn" id="showMoreBtn" style="display: none;">
            <span class="btn-text">Xem th√™m</span>
            <i class="bi bi-chevron-down"></i>
        </button>
    </div>
</div>

<!-- Bidding History -->
<div class="product-section">
    <div class="section-header">
        <h4><i class="bi bi-clock-history me-2"></i>Bidding History</h4>
        {{#if bidHistory}}
        <span class="bid-count">{{bidHistory.length}} bids</span>
        {{/if}}
        <!-- Debug info -->
        <small style="color: #999; margin-left: 10px;">
            (Winner ID: {{product.winner_id}}, Current Price: {{product.current_price}})
        </small>
    </div>
    <div class="section-content">
        {{#if bidHistory}}
            <table class="bid-history-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Bidder</th>
                        <th>Rating</th>
                        <th>Amount</th>
                        <th>Status</th>
                        {{#if (isEqual product.seller_id authUser.id)}}
                        <th>Actions</th>
                        {{/if}}
                    </tr>
                </thead>
                <tbody>
                    {{#each bidHistory}}
                    <tr class="{{#if is_banned}}banned-bid{{else}}{{#if is_current_winner}}winning-bid{{/if}}{{/if}}">
                        <td class="bid-time">{{time_str}}</td>
                        
                        <td>
                            <div class="bid-user">
                                <i class="bi bi-person-circle"></i>
                                <span>{{bidder_masked}}</span>
                            </div>
                        </td>

                        <td>
                            {{#if rating_count}}
                                <span class="rating-badge" title="{{rating_count}} reviews">
                                    <i class="bi bi-hand-thumbs-up-fill text-success"></i>
                                    {{calculate_rating_percentage rating_score rating_count}}%
                                </span>
                            {{else}}
                                <span class="text-muted">No rating</span>
                            {{/if}}
                        </td>
                        
                        <td class="bid-price">
                            {{format_currency price}}
                        </td>

                        <td>
                            {{#if is_banned}}
                                <span class="badge bg-danger">
                                    <i class="bi bi-slash-circle"></i> Rejected
                                </span>
                            {{else}}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> Active
                                </span>
                            {{/if}}
                        </td>

                        {{#if (isEqual ../product.seller_id ../authUser.id)}}
                        <td>
                            {{#if is_banned}}
                                <button class="kick-btn disabled" disabled title="Already banned">
                                    <i class="bi bi-x-circle me-1"></i>Rejected
                                </button>
                            {{else}}
                                {{#if (isEqual ../product.status 2)}}
                                    <button class="kick-btn disabled" disabled title="Auction ended - cannot reject">
                                        <i class="bi bi-x-circle me-1"></i>Reject
                                    </button>
                                {{else}}
                                    <form method="post" action="/products/kick" class="d-inline">
                                        <input type="hidden" name="proId" value="{{../product.id}}">
                                        <input type="hidden" name="bidderId" value="{{bidder_id}}">
                                        
                                        <button type="submit" class="kick-btn" 
                                                onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën c·∫•m ng∆∞·ªùi d√πng n√†y ƒë·∫•u gi√°?');"
                                                title="Ban this bidder">
                                            <i class="bi bi-x-circle me-1"></i>Reject
                                        </button>
                                    </form>
                                {{/if}}
                            {{/if}}
                        </td>
                        {{/if}}
                    </tr>
                    {{/each}}
                </tbody>
            </table>
            <button class="show-more-btn" id="showMoreBidsBtn" style="display: none;">
                <span class="btn-text">Xem th√™m</span>
                <i class="bi bi-chevron-down"></i>
            </button>
        {{else}}
            <p class="text-muted text-center mb-0">Ch∆∞a c√≥ l∆∞·ª£t ra gi√° n√†o.</p>
        {{/if}}
    </div>
</div>

<!-- Banned Bidders Section (Only for Seller and Active Auction) -->
{{#if (and isSeller (isEqual product.status 1))}}
<div class="product-section mt-4">
    <div class="section-header">
        <h4><i class="bi bi-shield-x me-2"></i>Banned Bidders</h4>
        <span class="bid-count">{{bannedBidders.length}} banned</span>
    </div>
    <div class="section-content">
        <!-- Form to add new banned bidder -->
        <div class="card mb-3 border-warning">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-plus-circle me-2"></i>Ban ng∆∞·ªùi d√πng m·ªõi</h6>
                <form method="post" action="/products/ban-user" class="row g-2">
                    <input type="hidden" name="proId" value="{{product.id}}">
                    <div class="col-md-9">
                        <input type="email" class="form-control" name="userEmail" 
                               placeholder="Nh·∫≠p email ng∆∞·ªùi d√πng c·∫ßn c·∫•m..." required>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-warning w-100" 
                                onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën c·∫•m ng∆∞·ªùi d√πng n√†y?');">
                            <i class="bi bi-ban me-1"></i>Ban User
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- List of banned bidders -->
        {{#if bannedBidders.length}}
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Rating</th>
                        <th>Banned At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each bannedBidders}}
                    <tr>
                        <td>
                            <i class="bi bi-person-fill-slash text-danger me-2"></i>
                            <strong>{{full_name}}</strong>
                        </td>
                        <td>{{email}}</td>
                        <td>
                            {{#if rating_count}}
                                <span class="rating-badge">
                                    <i class="bi bi-star-fill text-warning"></i>
                                    {{rating_score}} ({{rating_count}})
                                </span>
                            {{else}}
                                <span class="text-muted">No rating</span>
                            {{/if}}
                        </td>
                        <td class="text-muted small">
                            {{banned_at}}
                        </td>
                        <td>
                            <form method="post" action="/products/unban" class="d-inline">
                                <input type="hidden" name="proId" value="{{../product.id}}">
                                <input type="hidden" name="userId" value="{{id}}">
                                
                                <button type="submit" class="btn btn-sm btn-success" 
                                        onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën g·ª° b·ªè l·ªánh c·∫•m cho {{full_name}}?');"
                                        title="Unban this user">
                                    <i class="bi bi-check-circle me-1"></i>Unban
                                </button>
                            </form>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        {{else}}
            <p class="text-muted text-center mb-0">Ch∆∞a c√≥ ng∆∞·ªùi d√πng b·ªã c·∫•m.</p>
        {{/if}}
    </div>
</div>
{{/if}}

<div class="card mt-4 shadow-sm">
    <div class="card-header fw-bold bg-white">
        <i class="bi bi-question-circle"></i> H·ªèi ƒë√°p
    </div>
    <div class="card-body">
        {{#if isAuthenticated}}
        {{#unless (isEqual product.seller_id authUser.id)}}
        <form class="mb-4" method="post" action="/products/question">
            <input type="hidden" name="proId" value="{{product.id}}">
            <div class="input-group">
                <input type="text" class="form-control" name="question" placeholder="ƒê·∫∑t c√¢u h·ªèi ho·∫∑c tr·∫£ l·ªùi..." required>
                <button class="btn btn-outline-secondary" type="submit">
                    <i class="bi bi-send"></i> G·ª≠i
                </button>
            </div>
        </form>
        {{/unless}}
        {{else}}
            <div class="alert alert-warning">
                Vui l√≤ng <a href="/account/signin" class="signin-qa-link">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ tham gia h·ªèi ƒë√°p.
            </div>
        {{/if}}

        <div class="list-group list-group-flush">
            {{#each questions}}
            <div class="list-group-item">
                <div class="fw-bold">{{asker_name}}: <span class="fw-normal text-dark">{{question}}</span></div>
                <div class="text-muted small mb-1">{{created_at}}</div>
                
                {{#if answer}}
                <div class="ms-4 p-2 bg-light rounded border-start border-4 border-success">
                    <strong>Shop tr·∫£ l·ªùi:</strong> {{answer}}
                    <div class="text-muted small mt-1">{{answer_at}}</div>
                </div>
            {{else}}
                {{#if (isEqual ../product.seller_id ../authUser.id)}}
                    <form method="post" action="/products/answer" class="mt-2 ms-4">
                        <input type="hidden" name="proId" value="{{../product.id}}">
                        <input type="hidden" name="questionId" value="{{id}}">
                        
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" name="answer" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." required>
                            <button class="btn btn-success" type="submit">Tr·∫£ l·ªùi</button>
                        </div>
                    </form>
                {{/if}}

                {{/if}}
            </div>
            {{/each}}
        </div>
    </div>
</div>

<!-- Related Products -->
<div class="product-section">
    <div class="section-header">
        <h4><i class="bi bi-grid me-2"></i>Similar Items</h4>
        <a href="/products/byCat?id={{product.category_id}}" class="btn btn-sm btn-outline-primary">
            View All
        </a>
    </div>
    <div class="section-content">
        <div class="row g-3">
            {{#each relatedProducts}}
            <div class="col-lg-2 col-md-3 col-6">
                <div class="related-product-card">
                    <a href="/products/detail/{{id}}" class="product-link">
                        <div class="related-image">
                            <picture>
                                <source srcset="{{imageFallback imagePath id}}" type="image/webp">
                                <img src="{{imageFallback imagePath id}}" alt="{{name}}" loading="lazy" width="200" height="150">
                            </picture>
                        </div>
                        <div class="related-info">
                            <h6 class="related-title">{{name}}</h6>
                            <div class="related-price">{{format_currency current_price}}</div>
                            <div class="related-meta">
                                <span class="time-left">{{format_remainingTime end_time}}</span>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
            {{/each}}
        </div>
    </div>
</div>

{{#section 'js'}}
<script>
    let currentImageIndex = 0;
    const imageUrls = [{{#each images}}'{{src}}'{{#unless @last}},{{/unless}}{{/each}}];
    
    function changeImage(element, src, index) {
        const mainImage = document.getElementById('mainImage');
        const mainPicture = mainImage.parentElement;
        const mainSource = mainPicture.querySelector('source');
        
        // Add loading state
        mainImage.classList.add('loading');
        
        // Create a new image to preload
        const tempImg = new Image();
        tempImg.onload = function() {
            // Update sources
            if (mainSource) {
                mainSource.srcset = src;
            }
            mainImage.src = src;
            
            // Remove loading and add fade-in animation
            mainImage.classList.remove('loading');
            mainImage.classList.add('fade-in');
            setTimeout(() => mainImage.classList.remove('fade-in'), 400);
        };
        tempImg.src = src;
        
        // Update active state on thumbnails and wrappers
        document.querySelectorAll('.gallery-thumb').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.thumb-wrapper').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        element.closest('.thumb-wrapper').classList.add('active');
        
        // Update current index
        currentImageIndex = index;
    }
    
    function openLightbox(index) {
        const modal = document.getElementById('lightboxModal');
        const lightboxImage = document.getElementById('lightboxImage');
        const counter = document.getElementById('lightboxCounter');
        
        currentImageIndex = index;
        lightboxImage.src = imageUrls[index];
        counter.textContent = `${index + 1} / ${imageUrls.length}`;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closeLightbox(event) {
        if (event.target.id === 'lightboxModal' || event.target.closest('.lightbox-close')) {
            const modal = document.getElementById('lightboxModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    }
    
    function navigateLightbox(direction, event) {
        event.stopPropagation();
        currentImageIndex += direction;
        
        if (currentImageIndex < 0) {
            currentImageIndex = imageUrls.length - 1;
        } else if (currentImageIndex >= imageUrls.length) {
            currentImageIndex = 0;
        }
        
        const lightboxImage = document.getElementById('lightboxImage');
        const counter = document.getElementById('lightboxCounter');
        
        lightboxImage.style.opacity = '0';
        lightboxImage.style.transition = 'opacity 0.15s ease';
        setTimeout(() => {
            lightboxImage.src = imageUrls[currentImageIndex];
            lightboxImage.style.opacity = '1';
            counter.textContent = `${currentImageIndex + 1} / ${imageUrls.length}`;
        }, 150);
    }
    
    // Keyboard navigation for lightbox
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('lightboxModal');
        if (!modal.classList.contains('active')) return;
        
        if (e.key === 'Escape') {
            closeLightbox({ target: modal });
        } else if (e.key === 'ArrowLeft') {
            navigateLightbox(-1, e);
        } else if (e.key === 'ArrowRight') {
            navigateLightbox(1, e);
        }
    });

    function confirmBid() {
        const bidInput = document.getElementById('bidPriceInput');
        const priceValue = bidInput.value.replace(/,/g, '');
        const formattedPrice = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(priceValue);
        
        const isConfirmed = confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ra gi√° ${formattedPrice} cho s·∫£n ph·∫©m n√†y kh√¥ng?`);
        
        if (isConfirmed) {
            // Remove commas before submitting
            bidInput.value = priceValue;
            document.getElementById('frmBid').submit();
        }
    }

    // Format number with thousand separators when user types
    document.addEventListener('DOMContentLoaded', function() {
        const bidInput = document.getElementById('bidPriceInput');
        if (bidInput) {
            // Format initial value on page load
            const initialValue = bidInput.value.replace(/,/g, '');
            if (initialValue && !isNaN(initialValue)) {
                bidInput.value = Number(initialValue).toLocaleString('en-US');
            }

            bidInput.addEventListener('input', function(e) {
                let value = this.value.replace(/,/g, '');
                if (value && !isNaN(value)) {
                    // Store cursor position
                    const cursorPos = this.selectionStart;
                    const oldLength = this.value.length;
                    
                    // Format with commas
                    this.value = Number(value).toLocaleString('en-US');
                    
                    // Restore cursor position adjusted for new commas
                    const newLength = this.value.length;
                    const newCursorPos = cursorPos + (newLength - oldLength);
                    this.setSelectionRange(newCursorPos, newCursorPos);
                }
            });

            // Remove commas before form submission
            bidInput.form.addEventListener('submit', function(e) {
                bidInput.value = bidInput.value.replace(/,/g, '');
            });
        }
    });

    function incrementBid() {
        const bidInput = document.getElementById('bidPriceInput');
        const step = parseFloat(bidInput.dataset.step) || 1;
        let currentValue = parseFloat(bidInput.value.replace(/,/g, '')) || 0;
        currentValue += step;
        bidInput.value = Number(currentValue).toLocaleString('en-US');
    }

    function decrementBid() {
        const bidInput = document.getElementById('bidPriceInput');
        const step = parseFloat(bidInput.dataset.step) || 1;
        const minValue = parseFloat(bidInput.dataset.min) || 0;
        let currentValue = parseFloat(bidInput.value.replace(/,/g, '')) || 0;
        currentValue -= step;
        if (currentValue >= minValue) {
            bidInput.value = Number(currentValue).toLocaleString('en-US');
        }
    }

    // Product description collapse/expand
    (function() {
        const description = document.getElementById('productDescription');
        const showMoreBtn = document.getElementById('showMoreBtn');
        
        if (!description || !showMoreBtn) return;
        
        // Check if description needs collapse (height > 200px)
        const fullHeight = description.scrollHeight;
        if (fullHeight > 200) {
            showMoreBtn.style.display = 'inline-flex';
            
            showMoreBtn.addEventListener('click', function() {
                const isCollapsed = description.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Expand
                    description.classList.remove('collapsed');
                    this.querySelector('.btn-text').textContent = 'Thu g·ªçn';
                    this.classList.add('expanded');
                } else {
                    // Collapse
                    description.classList.add('collapsed');
                    this.querySelector('.btn-text').textContent = 'Xem th√™m';
                    this.classList.remove('expanded');
                    
                    // Scroll to description section
                    description.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        } else {
            // If content is short, remove collapsed class
            description.classList.remove('collapsed');
        }
    })();

    // Bid history collapse/expand
    (function() {
        const bidTable = document.querySelector('.bid-history-table');
        const showMoreBidsBtn = document.getElementById('showMoreBidsBtn');
        
        if (!bidTable || !showMoreBidsBtn) return;
        
        const rows = bidTable.querySelectorAll('tbody tr');
        const totalRows = rows.length;
        
        // Show button if more than 5 bids
        if (totalRows > 5) {
            bidTable.classList.add('collapsed');
            showMoreBidsBtn.style.display = 'inline-flex';
            
            showMoreBidsBtn.addEventListener('click', function() {
                const isCollapsed = bidTable.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Expand - show all bids
                    bidTable.classList.remove('collapsed');
                    this.querySelector('.btn-text').textContent = 'Thu g·ªçn';
                    this.classList.add('expanded');
                } else {
                    // Collapse - show only first 5
                    bidTable.classList.add('collapsed');
                    this.querySelector('.btn-text').textContent = 'Xem th√™m';
                    this.classList.remove('expanded');
                    
                    // Scroll to bid history section
                    bidTable.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }
    })();
</script>
{{/section}}

{{!-- Close the unless block opened at the top --}}
{{/unless}}