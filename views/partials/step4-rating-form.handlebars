<div class="card">
    <div class="card-header bg-warning">
        <h5>
            <i class="bi bi-4-circle"></i> BÆ°á»›c 4: ÄÃ¡nh giÃ¡ giao dá»‹ch
            <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" 
               title="ÄÃ¡nh giÃ¡ cháº¥t lÆ°á»£ng giao dá»‹ch Ä‘á»ƒ xÃ¢y dá»±ng uy tÃ­n"></i>
        </h5>
    </div>
    <div class="card-body">
        {{#if isBuyer}}
        <h6 class="mb-3">ÄÃ¡nh giÃ¡ ngÆ°á»i bÃ¡n</h6>
        <p class="text-muted">NgÆ°á»i bÃ¡n: <strong>{{seller.full_name}}</strong></p>
        {{else}}
        <h6 class="mb-3">ÄÃ¡nh giÃ¡ ngÆ°á»i mua</h6>
        <p class="text-muted">NgÆ°á»i mua: <strong>{{buyer.full_name}}</strong></p>
        {{/if}}

        {{!-- Check if already rated --}}
        {{#if hasRated}}
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i> Báº¡n Ä‘Ã£ Ä‘Ã¡nh giÃ¡: 
            <strong>{{#if (isEqual myRating.score 1)}}ğŸ‘ TÃ­ch cá»±c{{else}}ğŸ‘ TiÃªu cá»±c{{/if}}</strong>
            <p class="mb-0 mt-2">"{{myRating.comment}}"</p>
            <button class="btn btn-sm btn-outline-primary mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#editRating">
                Chá»‰nh sá»­a Ä‘Ã¡nh giÃ¡
            </button>
        </div>
        
        <div id="editRating" class="collapse">
        {{/if}}

        <form method="POST" action="/transaction/{{transaction.id}}/step4">
            <div class="mb-3">
                <label class="form-label">Chá»n Ä‘Ã¡nh giÃ¡</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="score" id="positive" value="1" required
                        {{#if (and hasRated (isEqual myRating.score 1))}}checked{{/if}}>
                    <label class="btn btn-outline-success" for="positive">
                        <i class="bi bi-hand-thumbs-up fs-4"></i><br>TÃ­ch cá»±c (+1)
                    </label>

                    <input type="radio" class="btn-check" name="score" id="negative" value="-1" required
                        {{#if (and hasRated (isEqual myRating.score -1))}}checked{{/if}}>
                    <label class="btn btn-outline-danger" for="negative">
                        <i class="bi bi-hand-thumbs-down fs-4"></i><br>TiÃªu cá»±c (-1)
                    </label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Nháº­n xÃ©t ngáº¯n</label>
                <textarea name="comment" class="form-control" rows="3" required
                    placeholder="Chia sáº» tráº£i nghiá»‡m cá»§a báº¡n vá» giao dá»‹ch nÃ y...">{{#if hasRated}}{{myRating.comment}}{{/if}}</textarea>
            </div>

            <button type="submit" class="btn btn-warning w-100">
                <i class="bi bi-star-fill"></i> {{#if hasRated}}Cáº­p nháº­t{{else}}Gá»­i{{/if}} Ä‘Ã¡nh giÃ¡
            </button>
        </form>

        {{#if hasRated}}
        </div>
        {{/if}}

        {{!-- Show waiting message if only one person rated --}}
        {{#if (and (not bothRated) partnerRated)}}
        <div class="alert alert-info mt-3">
            {{#if isBuyer}}NgÆ°á»i bÃ¡n{{else}}NgÆ°á»i mua{{/if}} Ä‘Ã£ Ä‘Ã¡nh giÃ¡. 
            Chá» báº¡n hoÃ n táº¥t Ä‘á»ƒ káº¿t thÃºc giao dá»‹ch.
        </div>
        {{/if}}

        {{!-- Show completion if both rated --}}
        {{#if bothRated}}
        <div class="alert alert-success mt-3">
            <i class="bi bi-check-circle-fill"></i> 
            <strong>Giao dá»‹ch Ä‘Ã£ hoÃ n táº¥t!</strong> Cáº£ hai bÃªn Ä‘Ã£ Ä‘Ã¡nh giÃ¡.
        </div>
        {{/if}}
    </div>
</div>
