<div class="container mt-4 mb-5">
    <div class="row">
        <!-- Left Column: Product Info Card -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <img src="{{product.main_image}}" class="card-img-top" alt="{{product.name}}" 
                    style="height: 250px; object-fit: cover;">
                <div class="card-body">
                    <h5 class="card-title">{{product.name}}</h5>
                    <p class="text-success fs-4 mb-3">
                        <i class="bi bi-currency-dollar"></i>
                        {{format_currency transaction.final_price}}
                    </p>
                    <hr>
                    <div class="mb-2">
                        <strong><i class="bi bi-shop"></i> Ng∆∞·ªùi b√°n:</strong>
                        <p class="mb-0">{{seller.full_name}}</p>
                    </div>
                    <div class="mb-3">
                        <strong><i class="bi bi-person-check"></i> Ng∆∞·ªùi mua:</strong>
                        <p class="mb-0">{{buyer.full_name}}</p>
                    </div>
                    <a href="/chat/with/{{chatPartnerId}}?ref=transaction&productId={{product.id}}" class="btn btn-outline-primary w-100">
                        <i class="bi bi-chat-dots"></i> Chat v·ªõi {{#if isBuyer}}ng∆∞·ªùi b√°n{{else}}ng∆∞·ªùi mua{{/if}}
                    </a>
                </div>
            </div>
        </div>

        <!-- Right Column: Transaction Progress & Forms -->
        <div class="col-md-8">
            <h3 class="mb-4">
                <i class="bi bi-receipt"></i> Ho√†n t·∫•t giao d·ªãch
            </h3>

            <!-- Progress Bar Component -->
            {{> transaction-progress transaction=transaction}}

            <!-- Dynamic Content Based on Status -->
            <div class="transaction-content">
                {{#if (isEqual transaction.status 0)}}
                    {{!-- Step 1: Waiting for payment --}}
                    {{#if isBuyer}}
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-1-circle"></i> B∆∞·ªõc 1: Thanh to√°n</h5>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="/transaction/{{transaction.id}}/step1" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng</label>
                                        <textarea name="shipping_address" class="form-control" rows="3" required
                                            placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë"></textarea>
                                        <small class="text-muted">ƒê·ªãa ch·ªâ n√†y s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ giao h√†ng</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ho√° ƒë∆°n thanh to√°n</label>
                                        <input type="file" name="payment_proof" class="form-control" 
                                            accept="image/*,.pdf" required>
                                        <small class="text-muted">JPG, PNG ho·∫∑c PDF, t·ªëi ƒëa 5MB</small>
                                    </div>

                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        Vui l√≤ng chuy·ªÉn kho·∫£n <strong>{{format_currency transaction.final_price}}</strong> 
                                        ƒë·∫øn t√†i kho·∫£n c·ªßa ng∆∞·ªùi b√°n v√† upload ·∫£nh ch·ª•p bi√™n lai.
                                    </div>

                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-upload"></i> Upload v√† Ti·∫øp t·ª•c
                                    </button>
                                </form>
                            </div>
                        </div>
                    {{else}}
                        <div class="alert alert-info">
                            <i class="bi bi-hourglass-split"></i>
                            <h5>ƒêang ch·ªù ng∆∞·ªùi mua thanh to√°n...</h5>
                            <p class="mb-0">Ng∆∞·ªùi mua s·∫Ω upload ho√° ƒë∆°n thanh to√°n v√† cung c·∫•p ƒë·ªãa ch·ªâ giao h√†ng.</p>
                        </div>
                    {{/if}}
                {{/if}}

                {{#if (isEqual transaction.status 1)}}
                    {{!-- Step 2: Payment submitted, waiting for shipping --}}
                    {{#if isSeller}}
                        <div class="card shadow-sm">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-2-circle"></i> B∆∞·ªõc 2: G·ª≠i h√†ng</h5>
                            </div>
                            <div class="card-body">
                                <!-- Display payment info first -->
                                <div class="alert alert-info mb-3">
                                    <h6><i class="bi bi-info-circle"></i> Th√¥ng tin thanh to√°n t·ª´ ng∆∞·ªùi mua:</h6>
                                    <p class="mb-2"><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong></p>
                                    <p class="ms-3">{{transaction.shipping_address}}</p>
                                    <p class="mb-0">
                                        <strong>Ho√° ƒë∆°n thanh to√°n:</strong> 
                                        <a href="{{transaction.payment_proof}}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-file-earmark-image"></i> Xem ho√° ƒë∆°n
                                        </a>
                                    </p>
                                </div>

                                <form method="POST" action="/transaction/{{transaction.id}}/step2">
                                    <div class="mb-3">
                                        <label class="form-label">M√£ v·∫≠n ƒë∆°n / Tracking Number</label>
                                        <input type="text" name="shipping_tracking" class="form-control" required
                                            placeholder="VD: VNP123456789">
                                        <small class="text-muted">Nh·∫≠p m√£ theo d√µi t·ª´ ƒë∆°n v·ªã v·∫≠n chuy·ªÉn</small>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="confirmShip" required>
                                        <label class="form-check-label" for="confirmShip">
                                            T√¥i x√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn v√† ƒë√£ g·ª≠i h√†ng
                                        </label>
                                    </div>

                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="bi bi-box-seam"></i> X√°c nh·∫≠n ƒë√£ g·ª≠i h√†ng
                                    </button>
                                </form>
                            </div>
                        </div>
                    {{else}}
                        <div class="alert alert-info">
                            <i class="bi bi-hourglass-split"></i>
                            <h5>ƒêang ch·ªù ng∆∞·ªùi b√°n x√°c nh·∫≠n v√† g·ª≠i h√†ng...</h5>
                            <p class="mb-2">Th√¥ng tin b·∫°n ƒë√£ cung c·∫•p:</p>
                            <p class="mb-1"><strong>ƒê·ªãa ch·ªâ:</strong> {{transaction.shipping_address}}</p>
                            <p class="mb-0">
                                <strong>Ho√° ƒë∆°n:</strong> 
                                <a href="{{transaction.payment_proof}}" target="_blank">Xem ho√° ƒë∆°n c·ªßa b·∫°n</a>
                            </p>
                        </div>
                    {{/if}}
                {{/if}}

                {{#if (isEqual transaction.status 2)}}
                    {{!-- Step 3: Shipped, waiting for buyer confirmation --}}
                    {{#if isBuyer}}
                        <div class="card shadow-sm">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-3-circle"></i> B∆∞·ªõc 3: X√°c nh·∫≠n ƒë√£ nh·∫≠n h√†ng</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success mb-3">
                                    <h6><i class="bi bi-box-seam"></i> Th√¥ng tin g·ª≠i h√†ng:</h6>
                                    <p class="mb-0"><strong>M√£ v·∫≠n ƒë∆°n:</strong> <code>{{transaction.shipping_tracking}}</code></p>
                                    <p class="mb-0 mt-2 text-muted">Vui l√≤ng ki·ªÉm tra s·∫£n ph·∫©m tr∆∞·ªõc khi x√°c nh·∫≠n.</p>
                                </div>

                                <form method="POST" action="/transaction/{{transaction.id}}/step3">
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <strong>L∆∞u √Ω:</strong> Sau khi x√°c nh·∫≠n, b·∫°n v√† ng∆∞·ªùi b√°n s·∫Ω ƒë√°nh gi√° nhau v·ªÅ ch·∫•t l∆∞·ª£ng giao d·ªãch.
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="confirmReceived" required>
                                        <label class="form-check-label" for="confirmReceived">
                                            T√¥i x√°c nh·∫≠n ƒë√£ nh·∫≠n h√†ng v√† s·∫£n ph·∫©m ƒë√∫ng nh∆∞ m√¥ t·∫£
                                        </label>
                                    </div>

                                    <button type="submit" class="btn btn-info w-100">
                                        <i class="bi bi-check-circle"></i> X√°c nh·∫≠n ƒë√£ nh·∫≠n h√†ng
                                    </button>
                                </form>
                            </div>
                        </div>
                    {{else}}
                        <div class="alert alert-info">
                            <i class="bi bi-hourglass-split"></i>
                            <h5>ƒê√£ g·ª≠i h√†ng. ƒêang ch·ªù ng∆∞·ªùi mua x√°c nh·∫≠n...</h5>
                            <p class="mb-0"><strong>M√£ v·∫≠n ƒë∆°n:</strong> <code>{{transaction.shipping_tracking}}</code></p>
                        </div>
                    {{/if}}
                {{/if}}

                {{#if (or (isEqual transaction.status 3) (isEqual transaction.status 4))}}
                    {{!-- Step 4: Rating phase --}}
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-warning">
                            <h5 class="mb-0"><i class="bi bi-4-circle"></i> B∆∞·ªõc 4: ƒê√°nh gi√° giao d·ªãch</h5>
                        </div>
                        <div class="card-body">
                            {{#if isBuyer}}
                                <h6 class="mb-3">ƒê√°nh gi√° ng∆∞·ªùi b√°n</h6>
                                <p class="text-muted">Ng∆∞·ªùi b√°n: <strong>{{seller.full_name}}</strong></p>
                            {{else}}
                                <h6 class="mb-3">ƒê√°nh gi√° ng∆∞·ªùi mua</h6>
                                <p class="text-muted">Ng∆∞·ªùi mua: <strong>{{buyer.full_name}}</strong></p>
                            {{/if}}

                            {{#if (and isBuyer hasRatedBuyer)}}
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i> B·∫°n ƒë√£ ƒë√°nh gi√°: 
                                    <strong>{{#if (isEqual buyerRating.score 1)}}üëç T√≠ch c·ª±c{{else}}üëé Ti√™u c·ª±c{{/if}}</strong>
                                    <p class="mb-0 mt-2">"{{buyerRating.comment}}"</p>
                                    <button class="btn btn-sm btn-outline-primary mt-2" data-bs-toggle="collapse" data-bs-target="#editRating">
                                        Ch·ªânh s·ª≠a ƒë√°nh gi√°
                                    </button>
                                </div>
                            {{/if}}

                            {{#if (and isSeller hasRatedSeller)}}
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i> B·∫°n ƒë√£ ƒë√°nh gi√°: 
                                    <strong>{{#if (isEqual sellerRating.score 1)}}üëç T√≠ch c·ª±c{{else}}üëé Ti√™u c·ª±c{{/if}}</strong>
                                    <p class="mb-0 mt-2">"{{sellerRating.comment}}"</p>
                                    <button class="btn btn-sm btn-outline-primary mt-2" data-bs-toggle="collapse" data-bs-target="#editRating">
                                        Ch·ªânh s·ª≠a ƒë√°nh gi√°
                                    </button>
                                </div>
                            {{/if}}

                            <div id="editRating" class="collapse {{#if (or (and isBuyer (not hasRatedBuyer)) (and isSeller (not hasRatedSeller)))}}show{{/if}}">
                                <form method="POST" action="/transaction/{{transaction.id}}/step4">
                                    <div class="mb-3">
                                        <label class="form-label">Ch·ªçn ƒë√°nh gi√°</label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="score" id="positive" value="1" required
                                                {{#if (and isBuyer hasRatedBuyer (isEqual buyerRating.score 1))}}checked{{/if}}
                                                {{#if (and isSeller hasRatedSeller (isEqual sellerRating.score 1))}}checked{{/if}}>
                                            <label class="btn btn-outline-success" for="positive">
                                                <i class="bi bi-hand-thumbs-up fs-4"></i><br>T√≠ch c·ª±c (+1)
                                            </label>

                                            <input type="radio" class="btn-check" name="score" id="negative" value="-1" required
                                                {{#if (and isBuyer hasRatedBuyer (isEqual buyerRating.score -1))}}checked{{/if}}
                                                {{#if (and isSeller hasRatedSeller (isEqual sellerRating.score -1))}}checked{{/if}}>
                                            <label class="btn btn-outline-danger" for="negative">
                                                <i class="bi bi-hand-thumbs-down fs-4"></i><br>Ti√™u c·ª±c (-1)
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Nh·∫≠n x√©t ng·∫Øn</label>
                                        <textarea name="comment" class="form-control" rows="3" required
                                            placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ giao d·ªãch n√†y...">{{#if (and isBuyer hasRatedBuyer)}}{{buyerRating.comment}}{{/if}}{{#if (and isSeller hasRatedSeller)}}{{sellerRating.comment}}{{/if}}</textarea>
                                    </div>

                                    <button type="submit" class="btn btn-warning w-100">
                                        <i class="bi bi-star-fill"></i> 
                                        {{#if (or hasRatedBuyer hasRatedSeller)}}C·∫≠p nh·∫≠t{{else}}G·ª≠i{{/if}} ƒë√°nh gi√°
                                    </button>
                                </form>
                            </div>

                            {{!-- Show completion status --}}
                            {{#if bothRated}}
                                <div class="alert alert-success mt-3">
                                    <i class="bi bi-check-circle-fill"></i> 
                                    <strong>Giao d·ªãch ƒë√£ ho√†n t·∫•t!</strong> C·∫£ hai b√™n ƒë√£ ƒë√°nh gi√°.
                                </div>
                            {{else}}
                                <div class="alert alert-info mt-3">
                                    {{#if (and isBuyer hasRatedBuyer)}}ƒêang ch·ªù ng∆∞·ªùi b√°n ƒë√°nh gi√°...{{/if}}
                                    {{#if (and isSeller hasRatedSeller)}}ƒêang ch·ªù ng∆∞·ªùi mua ƒë√°nh gi√°...{{/if}}
                                    {{#if (and isBuyer (not hasRatedBuyer))}}Vui l√≤ng ƒë√°nh gi√° ƒë·ªÉ ho√†n t·∫•t giao d·ªãch.{{/if}}
                                    {{#if (and isSeller (not hasRatedSeller))}}Vui l√≤ng ƒë√°nh gi√° ƒë·ªÉ ho√†n t·∫•t giao d·ªãch.{{/if}}
                                </div>
                            {{/if}}
                        </div>
                    </div>
                {{/if}}

                {{#if (isEqual transaction.status 5)}}
                    {{!-- Canceled --}}
                    <div class="alert alert-danger">
                        <h4><i class="bi bi-x-circle-fill"></i> Giao d·ªãch ƒë√£ b·ªã h·ªßy</h4>
                        <p class="mb-0">Giao d·ªãch n√†y ƒë√£ b·ªã ng∆∞·ªùi b√°n h·ªßy b·ªè.</p>
                    </div>
                {{/if}}

                <!-- Cancel Button (Seller only, status < 3) -->
                {{#if (and isSeller (lt transaction.status 3) (not (isEqual transaction.status 5)))}}
                    <hr class="my-4">
                    <div class="text-center">
                        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">
                            <i class="bi bi-x-circle"></i> H·ªßy giao d·ªãch
                        </button>
                        <p class="text-muted mt-2 small">Ch·ªâ n√™n h·ªßy khi ng∆∞·ªùi mua kh√¥ng ph·∫£n h·ªìi ho·∫∑c vi ph·∫°m th·ªèa thu·∫≠n</p>
                    </div>
                {{/if}}
            </div>
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> H·ªßy giao d·ªãch</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/transaction/{{transaction.id}}/cancel">
                <div class="modal-body">
                    <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy giao d·ªãch n√†y?</p>
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>C·∫£nh b√°o:</strong> Ng∆∞·ªùi mua s·∫Ω nh·∫≠n ƒë√°nh gi√° -1 v√† kh√¥ng th·ªÉ ho√†n t√°c.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">L√Ω do h·ªßy</label>
                        <textarea name="reason" class="form-control" rows="3" required
                            placeholder="VD: Ng∆∞·ªùi mua kh√¥ng thanh to√°n trong 24h sau khi ƒë·∫•u gi√° k·∫øt th√∫c"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-x-circle"></i> X√°c nh·∫≠n h·ªßy
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{{#section 'css'}}
<link rel="stylesheet" href="/static/css/transaction.css">
{{/section}}

{{#section 'js'}}
<script>
    // Loading overlay
    const showLoading = () => {
        const overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.innerHTML = `
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-white">ƒêang x·ª≠ l√Ω...</p>
            </div>
        `;
        overlay.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); z-index: 9999; display: flex; 
            align-items: center; justify-content: center;
        `;
        document.body.appendChild(overlay);
    };

    // Show loading on all form submissions
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            // Don't show loading for cancel modal (already has confirmation)
            if (!this.closest('#cancelModal')) {
                showLoading();
            }
        });
    });

    // Show success toast if redirected after successful action
    {{#if session.successMessage}}
    const toast = document.createElement('div');
    toast.className = 'toast-notification success';
    toast.innerHTML = `
        <i class="bi bi-check-circle-fill"></i>
        <span>{{session.successMessage}}</span>
    `;
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        background: #28a745; color: white; padding: 1rem 1.5rem;
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex; align-items: center; gap: 0.5rem;
        animation: slideIn 0.3s ease-out;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
    {{/if}}

    // Show error toast if any
    {{#if session.errorMessage}}
    const errorToast = document.createElement('div');
    errorToast.className = 'toast-notification error';
    errorToast.innerHTML = `
        <i class="bi bi-exclamation-circle-fill"></i>
        <span>{{session.errorMessage}}</span>
    `;
    errorToast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        background: #dc3545; color: white; padding: 1rem 1.5rem;
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex; align-items: center; gap: 0.5rem;
        animation: slideIn 0.3s ease-out;
    `;
    document.body.appendChild(errorToast);
    setTimeout(() => errorToast.remove(), 4000);
    {{/if}}

    // File input preview
    const fileInput = document.querySelector('input[type="file"]');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
                const fileType = file.type;
                
                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File qu√° l·ªõn! Vui l√≤ng ch·ªçn file d∆∞·ªõi 5MB.');
                    this.value = '';
                    return;
                }
                
                // Validate file type
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
                if (!allowedTypes.includes(fileType)) {
                    alert('Ch·ªâ ch·∫•p nh·∫≠n file JPG, PNG ho·∫∑c PDF!');
                    this.value = '';
                    return;
                }
                
                // Show preview info
                const previewDiv = document.createElement('div');
                previewDiv.className = 'alert alert-info mt-2';
                previewDiv.innerHTML = `
                    <i class="bi bi-file-earmark-check"></i>
                    <strong>${file.name}</strong> (${fileSize} MB)
                `;
                
                // Remove old preview if exists
                const oldPreview = this.parentElement.querySelector('.alert');
                if (oldPreview) oldPreview.remove();
                
                this.parentElement.appendChild(previewDiv);
            }
        });
    }

    // Initialize Bootstrap tooltips
    document.addEventListener('DOMContentLoaded', function() {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    // Real-time validation for textareas
    const textareas = document.querySelectorAll('textarea[minlength]');
    textareas.forEach(textarea => {
        const minLength = parseInt(textarea.getAttribute('minlength'));
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'invalid-feedback';
        feedbackDiv.style.display = 'block';
        textarea.parentElement.appendChild(feedbackDiv);

        textarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            if (currentLength > 0 && currentLength < minLength) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
                feedbackDiv.textContent = `C·∫ßn th√™m ${minLength - currentLength} k√Ω t·ª± n·ªØa (t·ªëi thi·ªÉu ${minLength} k√Ω t·ª±)`;
            } else if (currentLength >= minLength) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                feedbackDiv.textContent = '';
            } else {
                this.classList.remove('is-invalid', 'is-valid');
                feedbackDiv.textContent = '';
            }
        });
    });

    // Enhanced cancel confirmation
    const cancelModalBtn = document.querySelector('#cancelModal button[type="submit"]');
    if (cancelModalBtn) {
        const cancelForm = cancelModalBtn.closest('form');
        cancelForm.addEventListener('submit', function(e) {
            const reason = this.querySelector('textarea[name="reason"]').value.trim();
            if (reason.length < 20) {
                e.preventDefault();
                alert('Vui l√≤ng nh·∫≠p l√Ω do h·ªßy giao d·ªãch (t·ªëi thi·ªÉu 20 k√Ω t·ª±)');
                return false;
            }
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy giao d·ªãch n√†y? H√†nh ƒë·ªông n√†y s·∫Ω l√†m gi·∫£m 1 ƒëi·ªÉm uy t√≠n c·ªßa b·∫°n.')) {
                e.preventDefault();
                return false;
            }
        });
    }

    // Add animation keyframes
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);
</script>
{{/section}}
